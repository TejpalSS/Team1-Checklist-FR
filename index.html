<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Cleaning Kanban Board</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        .kanban-column {
            min-height: 70vh; /* Ensures columns are visible even when empty */
        }
        /* Styling for drag-and-drop */
        .task-card {
            cursor: grab;
            transition: all 0.2s;
        }
        .task-card:active {
            cursor: grabbing;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }
        .drag-over {
            border: 3px dashed #6366f1;
            background-color: #e0e7ff;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Team Key Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Enter Team Key</h2>
            <p class="text-gray-600 mb-6">This key acts as a shared password to access the correct board data.</p>
            <input type="text" id="team-key-input" placeholder="e.g., NightCrewAlpha" 
                   class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 mb-4">
            <button id="load-board-button" 
                    class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                Load Shared Board
            </button>
            <p class="text-xs text-red-500 mt-4" id="key-error" style="display:none;">Please enter a key to proceed.</p>
        </div>
    </div>
    
    <!-- Main Kanban App Container -->
    <div id="app-container" class="max-w-7xl mx-auto" style="display: none;">
        <header class="text-center mb-8 p-6 bg-white rounded-2xl shadow-xl">
            <h1 class="text-3xl font-extrabold text-indigo-800 tracking-tight">
                Shared Kanban Team Checklist
            </h1>
            <p class="text-sm text-gray-500 mt-2">
                Board Key: <span id="current-key-display" class="font-bold text-indigo-500"></span>
                <span class="text-xs text-red-500 ml-4">(Remember to refresh to see teammates' updates!)</span>
            </p>
        </header>

        <!-- Kanban Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- To Do Column -->
            <div id="todo-column" class="kanban-column bg-white p-4 rounded-2xl shadow-lg transition-shadow duration-300 border-t-8 border-red-500">
                <h2 class="text-xl font-bold mb-4 text-red-700 flex justify-between items-center">
                    To Do
                    <span id="todo-count" class="bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full"></span>
                </h2>
                <div id="todo-list" class="space-y-3 pt-1">
                    <!-- Tasks will be injected here -->
                    <p class="text-center text-gray-400">Drag tasks here.</p>
                </div>
            </div>

            <!-- In Progress Column -->
            <div id="inprogress-column" class="kanban-column bg-white p-4 rounded-2xl shadow-lg transition-shadow duration-300 border-t-8 border-yellow-500">
                <h2 class="text-xl font-bold mb-4 text-yellow-700 flex justify-between items-center">
                    In Progress
                    <span id="inprogress-count" class="bg-yellow-500 text-white text-xs font-semibold px-2 py-1 rounded-full"></span>
                </h2>
                <div id="inprogress-list" class="space-y-3 pt-1">
                    <!-- Tasks will be injected here -->
                    <p class="text-center text-gray-400">Drag tasks here.</p>
                </div>
            </div>

            <!-- Completed Column -->
            <div id="completed-column" class="kanban-column bg-white p-4 rounded-2xl shadow-lg transition-shadow duration-300 border-t-8 border-green-500">
                <h2 class="text-xl font-bold mb-4 text-green-700 flex justify-between items-center">
                    Completed
                    <span id="completed-count" class="bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded-full"></span>
                </h2>
                <div id="completed-list" class="space-y-3 pt-1">
                    <!-- Tasks will be injected here -->
                    <p class="text-center text-gray-400">Drag tasks here.</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY_PREFIX = 'kanban_team_list_';
        const teamKeyInput = document.getElementById('team-key-input');
        const loadBoardButton = document.getElementById('load-board-button');
        const modal = document.getElementById('modal');
        const appContainer = document.getElementById('app-container');
        const lists = {
            'todo': document.getElementById('todo-list'),
            'inprogress': document.getElementById('inprogress-list'),
            'completed': document.getElementById('completed-list')
        };
        const counts = {
            'todo': document.getElementById('todo-count'),
            'inprogress': document.getElementById('inprogress-count'),
            'completed': document.getElementById('completed-count')
        };
        let currentTeamKey = '';
        let tasks = [];

        // --- 50 Initial Tasks ---
        const initialTasks = [
            { id: 'task_1', text: 'Cycle 1: Clean all Female Toilets and Break Rooms.', status: 'todo' },
            { id: 'task_2', text: 'Cycle 1: Clean all Male Toilets and Changing Rooms.', status: 'todo' },
            { id: 'task_3', text: 'QA Check 1: Inspect Area 1 floors and baseboards.', status: 'todo' },
            { id: 'task_4', text: 'Break Room: Fully restock all coffee and tea supplies.', status: 'todo' },
            { id: 'task_5', text: 'Cycle 2: Wipe down all high-touch surfaces (door handles, switches).', status: 'todo' },
            { id: 'task_6', text: 'Cycle 2: Polish all chrome and mirrors in both areas.', status: 'todo' },
            { id: 'task_7', text: 'Restock all soap and paper products in Area 2 bathrooms.', status: 'todo' },
            { id: 'task_8', text: 'Cycle 3: Final sweep and mop of all hard floor areas.', status: 'todo' },
            { id: 'task_9', text: 'Cycle 3: Check all trash receptacles for liners.', status: 'todo' },
            { id: 'task_10', text: 'Closeout: Sanitize all cleaning equipment and carts.', status: 'todo' }
        ];
        for (let i = 11; i <= 20; i++) {
            initialTasks.push({ id: `task_${i}`, text: `Zone A - High Dusting and Ledge Cleaning ${i}`, status: 'todo' });
        }
        for (let i = 21; i <= 35; i++) {
            initialTasks.push({ id: `task_${i}`, text: `Zone B - Floor Care and Spot Removal Task ${i}`, status: 'todo' });
        }
        for (let i = 36; i <= 50; i++) {
            initialTasks.push({ id: `task_${i}`, text: `Zone C - Restroom Detail and Supply Restock ${i}`, status: 'todo' });
        }
        
        // --- Core Functions ---

        /**
         * Loads tasks from Local Storage based on the team key. If none exist, loads initial tasks.
         */
        function loadTasks() {
            const storedData = localStorage.getItem(STORAGE_KEY_PREFIX + currentTeamKey);
            if (storedData) {
                try {
                    tasks = JSON.parse(storedData);
                    // Ensure all initial tasks are present if new tasks were added to the initial list
                    initialTasks.forEach(initialTask => {
                        if (!tasks.find(t => t.id === initialTask.id)) {
                            tasks.push(initialTask);
                        }
                    });
                } catch (e) {
                    console.error("Error parsing stored data:", e);
                    tasks = [...initialTasks];
                }
            } else {
                tasks = [...initialTasks];
                saveTasks();
            }
            renderTasks();
        }

        /**
         * Saves the current task state to Local Storage using the team key.
         */
        function saveTasks() {
            try {
                localStorage.setItem(STORAGE_KEY_PREFIX + currentTeamKey, JSON.stringify(tasks));
                console.log(`Tasks saved for key: ${currentTeamKey}`);
            } catch (e) {
                console.error("Error saving to Local Storage:", e);
            }
        }

        /**
         * Renders all tasks into their respective columns.
         */
        function renderTasks() {
            let columnCounts = { 'todo': 0, 'inprogress': 0, 'completed': 0 };

            // Clear lists
            Object.values(lists).forEach(list => list.innerHTML = '');

            tasks.forEach(task => {
                const card = createTaskCard(task);
                const listContainer = lists[task.status] || lists['todo'];
                listContainer.appendChild(card);
                columnCounts[task.status] = (columnCounts[task.status] || 0) + 1;
            });

            // Update counts and empty messages
            Object.keys(lists).forEach(status => {
                counts[status].textContent = columnCounts[status];
                if (columnCounts[status] === 0) {
                    lists[status].innerHTML = `<p class="text-center text-gray-400 p-4">Drag tasks here.</p>`;
                }
            });
        }

        /**
         * Creates the draggable HTML element for a single task.
         */
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.id = task.id;
            card.draggable = true;
            card.classList.add('task-card', 'p-3', 'rounded-lg', 'shadow-md', 'text-gray-800');
            
            // Set color based on status
            if (task.status === 'completed') {
                card.classList.add('bg-green-100', 'border-l-4', 'border-green-500');
            } else if (task.status === 'inprogress') {
                card.classList.add('bg-yellow-100', 'border-l-4', 'border-yellow-500');
            } else {
                card.classList.add('bg-indigo-100', 'border-l-4', 'border-indigo-500');
            }

            card.innerHTML = `<p class="font-medium">${task.text}</p>`;
            
            card.addEventListener('dragstart', handleDragStart);
            return card;
        }

        /**
         * Updates the status of a task after a successful drag-and-drop.
         */
        function updateTaskStatus(taskId, newStatus) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                tasks[taskIndex].status = newStatus;
                saveTasks();
                renderTasks(); // Re-render to update counts and card styling
            }
        }

        // --- Drag and Drop Handlers ---

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.id); // Set the task ID
            e.target.classList.add('opacity-50');
        }

        function handleDragOver(e) {
            e.preventDefault(); // Required to allow dropping
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const taskId = e.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(taskId);
            
            if (draggedElement) {
                draggedElement.classList.remove('opacity-50');
                // Determine the new status from the column ID
                let newStatus = e.currentTarget.id.replace('-list', '');

                // Safety check: ensure the drop target is a list container
                if (lists[newStatus]) {
                    updateTaskStatus(taskId, newStatus);
                }
            }
        }
        
        // --- Setup and Event Listeners ---
        
        function setupColumnListeners() {
            Object.values(lists).forEach(list => {
                // Add drag-and-drop event listeners to each task list container
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('dragleave', handleDragLeave);
                list.addEventListener('drop', handleDrop);
            });
        }
        
        function initApp() {
            // Check if a team key is in the URL hash, otherwise show modal
            const hashKey = window.location.hash.substring(1); 
            if (hashKey) {
                currentTeamKey = hashKey;
                document.getElementById('current-key-display').textContent = currentTeamKey;
                modal.style.display = 'none';
                appContainer.style.display = 'block';
                loadTasks();
                setupColumnListeners();
            } else {
                modal.style.opacity = 1;
            }
        }

        loadBoardButton.addEventListener('click', () => {
            const key = teamKeyInput.value.trim();
            if (key) {
                // Fix: Set the URL hash first.
                window.location.hash = key;
                
                // Fix: Manually call initApp() immediately to load the data 
                // and close the modal, in case the browser doesn't trigger a full reload.
                initApp(); 

            } else {
                const error = document.getElementById('key-error');
                error.style.display = 'block';
                setTimeout(() => error.style.display = 'none', 3000);
            }
        });
        
        window.addEventListener('load', initApp);

    </script>
</body>
</html>

