<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Daily Checklist with Time Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        .task-list {
            max-height: 75vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Team Key Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Enter Team Key</h2>
            <p class="text-gray-600 mb-6">This key acts as a shared password to access the correct board data.</p>
            <input type="text" id="team-key-input" placeholder="e.g., NightCrewAlpha" 
                   class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 mb-4">
            <button id="load-board-button" 
                    class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                Load Shared Board
            </button>
            <p class="text-xs text-red-500 mt-4" id="key-error" style="display:none;">Please enter a key to proceed.</p>
        </div>
    </div>
    
    <!-- Main App Container (Checklist View) -->
    <div id="app-container" class="max-w-4xl mx-auto" style="display: none;">
        <header class="text-center mb-8 p-6 bg-white rounded-2xl shadow-xl">
            <h1 class="text-3xl font-extrabold text-indigo-800 tracking-tight">
                Day 1 Checklist
            </h1>
            <p class="text-sm text-gray-500 mt-2">
                Board Key: <span id="current-key-display" class="font-bold text-indigo-500"></span>
            </p>
        </header>

        <!-- Checklist -->
        <div id="checklist-container" class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-gray-700">50 Daily Tasks</h2>
            
            <!-- Task List Scrollable Area -->
            <div id="todo-list" class="task-list space-y-3">
                <!-- Tasks will be injected here -->
                <p class="text-center text-gray-400">Loading tasks...</p>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY_PREFIX = 'kanban_team_list_';
        const teamKeyInput = document.getElementById('team-key-input');
        const loadBoardButton = document.getElementById('load-board-button');
        const modal = document.getElementById('modal');
        const appContainer = document.getElementById('app-container');
        const todoList = document.getElementById('todo-list');

        let currentTeamKey = '';
        let tasks = [];

        // --- 50 Initial Tasks (Day 1) ---
        const initialTasks = [];
        const baseTasks = [
            'Clean all Female Toilets and Break Rooms',
            'Clean all Male Toilets and Changing Rooms',
            'QA Check 1: Inspect Area 1 floors and baseboards',
            'Break Room: Fully restock all coffee and tea supplies',
            'Cycle 2: Wipe down all high-touch surfaces (door handles, switches)',
            'Cycle 2: Polish all chrome and mirrors in both areas',
            'Restock all soap and paper products in Area 2 bathrooms',
            'Cycle 3: Final sweep and mop of all hard floor areas',
            'Cycle 3: Check all trash receptacles for liners',
            'Closeout: Sanitize all cleaning equipment and carts'
        ];

        // Generate 50 unique tasks
        for (let i = 1; i <= 50; i++) {
            let taskText;
            if (i <= 10) {
                taskText = `Task ${i}: ${baseTasks[i-1]}`;
            } else if (i <= 25) {
                taskText = `Zone A - High Dusting and Ledge Cleaning Detail ${i-10}`;
            } else if (i <= 40) {
                taskText = `Zone B - Floor Care and Spot Removal Detail ${i-25}`;
            } else {
                taskText = `Zone C - Restroom Supply Check & Deep Detail ${i-40}`;
            }
            
            initialTasks.push({ 
                id: `task_${i}`, 
                text: taskText, 
                day: 'Day 1',
                status: 'todo', // todo, inprogress, completed
                startTime: null,
                endTime: null,
                duration: null
            });
        }
        
        // --- Core Functions ---

        /**
         * Converts milliseconds to a human-readable duration string (e.g., "1h 35m").
         */
        function formatDuration(ms) {
            if (!ms || ms < 0) return 'N/A';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0 && hours === 0 && minutes === 0) parts.push(`${seconds}s`);
            
            return parts.length > 0 ? parts.join(' ') : 'Less than 1s';
        }

        /**
         * Loads tasks from Local Storage based on the team key. If none exist, loads initial tasks.
         */
        function loadTasks() {
            const storedData = localStorage.getItem(STORAGE_KEY_PREFIX + currentTeamKey);
            if (storedData) {
                try {
                    tasks = JSON.parse(storedData);
                    // Ensure new properties (like duration fields) exist if loading old data
                    tasks = tasks.map(t => ({
                        ...t,
                        startTime: t.startTime || null,
                        endTime: t.endTime || null,
                        duration: t.duration || null,
                        day: t.day || 'Day 1', // Ensure Day 1 property exists
                        status: t.status || 'todo'
                    }));

                    // Ensure all 50 initial tasks are present
                    initialTasks.forEach(initialTask => {
                        if (!tasks.find(t => t.id === initialTask.id)) {
                            tasks.push(initialTask);
                        }
                    });

                } catch (e) {
                    console.error("Error parsing stored data:", e);
                    tasks = [...initialTasks];
                }
            } else {
                tasks = [...initialTasks];
                saveTasks();
            }
            renderTasks();
        }

        /**
         * Saves the current task state to Local Storage using the team key.
         */
        function saveTasks() {
            try {
                localStorage.setItem(STORAGE_KEY_PREFIX + currentTeamKey, JSON.stringify(tasks));
                console.log(`Tasks saved for key: ${currentTeamKey}`);
            } catch (e) {
                console.error("Error saving to Local Storage:", e);
            }
        }

        /**
         * Renders all tasks into the single checklist container.
         */
        function renderTasks() {
            todoList.innerHTML = '';

            tasks
                .filter(t => t.day === 'Day 1') // Only show Day 1 tasks
                .sort((a, b) => {
                    // Sort order: In Progress -> To Do -> Completed
                    const statusOrder = { 'inprogress': 0, 'todo': 1, 'completed': 2 };
                    return statusOrder[a.status] - statusOrder[b.status];
                })
                .forEach(task => {
                    const card = createTaskCard(task);
                    todoList.appendChild(card);
                });
                
            if (tasks.length === 0) {
                todoList.innerHTML = `<p class="text-center text-gray-400 p-4">No tasks found for Day 1.</p>`;
            }
        }

        /**
         * Creates the HTML element for a single time-tracked task.
         */
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.id = task.id;
            card.classList.add('p-4', 'rounded-lg', 'shadow-sm', 'flex', 'justify-between', 'items-center', 'transition-colors', 'duration-200');
            
            let actionButtonHTML = '';
            let durationDisplay = '';
            let textColor = 'text-gray-800';
            
            // Determine card appearance and button state based on status
            if (task.status === 'completed') {
                card.classList.add('bg-green-100', 'border-l-4', 'border-green-500');
                textColor = 'text-green-700';
                const duration = formatDuration(task.duration);
                durationDisplay = `<span class="text-sm font-semibold text-gray-600">Time Taken: ${duration}</span>`;
                actionButtonHTML = `<span class="text-sm font-bold text-green-600">COMPLETE</span>`;
            } else if (task.status === 'inprogress') {
                card.classList.add('bg-yellow-100', 'border-l-4', 'border-yellow-500');
                textColor = 'text-yellow-800';
                actionButtonHTML = `<button onclick="completeTask('${task.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-white p-2 px-3 rounded-lg text-sm font-semibold shadow-md">Mark Complete</button>`;
                durationDisplay = `<span class="text-sm text-yellow-700 font-medium">Task in Progress...</span>`;
            } else { // todo
                card.classList.add('bg-indigo-50', 'border-l-4', 'border-indigo-300');
                textColor = 'text-gray-800';
                actionButtonHTML = `<button onclick="startTask('${task.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 px-3 rounded-lg text-sm font-semibold shadow-md">Start Task</button>`;
            }

            // Task content area
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('flex-grow');
            contentDiv.innerHTML = `<p class="font-medium ${textColor}">${task.text}</p>`;

            // Controls/Info area
            const controlDiv = document.createElement('div');
            controlDiv.classList.add('flex', 'items-center', 'space-x-4', 'ml-4', 'flex-shrink-0');
            controlDiv.innerHTML = `${durationDisplay} ${actionButtonHTML}`;

            card.appendChild(contentDiv);
            card.appendChild(controlDiv);
            
            return card;
        }
        
        // --- Task State Handlers ---
        
        window.startTask = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.status === 'todo') {
                task.status = 'inprogress';
                task.startTime = Date.now();
                saveTasks();
                renderTasks();
            }
        }

        window.completeTask = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.status === 'inprogress') {
                task.status = 'completed';
                task.endTime = Date.now();
                // Calculate duration in milliseconds
                task.duration = task.endTime - task.startTime; 
                saveTasks();
                renderTasks();
            }
        }

        // --- Initialization and UI Logic ---
        
        /**
         * Initializes the board UI and loads/saves tasks based on the given key.
         */
        function initializeBoard(key) {
            currentTeamKey = key;
            
            // 1. Ensure URL hash is set for sharing
            if (window.location.hash.substring(1) !== key) {
                window.location.hash = key;
            }
            
            // 2. Update UI: Hide modal and show app container IMMEDIATELY
            document.getElementById('current-key-display').textContent = currentTeamKey;
            
            // Aggressive display changes to ensure UI updates
            modal.style.setProperty('display', 'none', 'important'); 
            appContainer.style.setProperty('display', 'block', 'important'); 

            // 3. Load Tasks
            loadTasks();
        }

        function initApp() {
            // Check if key already in URL (from a shared link or previous session)
            const hashKey = window.location.hash.substring(1); 
            if (hashKey) {
                // If key is found (e.g., #Team), initialize the board.
                initializeBoard(hashKey);
            } else {
                // If no key, ensure the modal is explicitly visible and centered for input
                modal.style.display = 'flex';
            }
        }

        loadBoardButton.addEventListener('click', () => {
            const key = teamKeyInput.value.trim();
            if (key) {
                // Directly call the new function to load the board and set the display
                initializeBoard(key);
            } else {
                const error = document.getElementById('key-error');
                error.style.display = 'block';
                setTimeout(() => error.style.display = 'none', 3000);
            }
        });
        
        window.addEventListener('load', initApp);

    </script>
</body>
</html>


