<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Daily Checklist with Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        .task-list {
            max-height: 28vh; /* Adjusted height for two lists */
            overflow-y: auto;
        }
        .admin-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        .admin-panel.open {
            max-height: 500px; 
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .selector-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }
        .selector-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .selector-inactive {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Enter Team Key</h2>
            <p class="text-gray-600 mb-6">This key acts as a shared password to access the correct board data.</p>
            <input type="text" id="team-key-input" placeholder="e.g., NightCrewAlpha" 
                   class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 mb-4">
            <button id="load-board-button" 
                    class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition-colors duration-200">
                Load Shared Board
            </button>
            <p class="text-xs text-red-500 mt-4" id="key-error" style="display:none;">Please enter a key to proceed.</p>
        </div>
    </div>
    
    <div id="app-container" class="max-w-4xl mx-auto" style="display: none;">
        <header class="text-center mb-6 p-6 bg-white rounded-2xl shadow-xl">
            <h1 id="main-title" class="text-3xl font-extrabold text-indigo-800 tracking-tight">
                Day 1 - Morning Shift
            </h1>
            <p class="text-sm text-gray-500 mt-2">
                Board Key: <span id="current-key-display" class="font-bold text-indigo-500"></span>
            </p>
        </header>
        
        <div class="flex justify-center space-x-4 mb-4">
            <button id="day-1-button" onclick="changeDay('Day 1')" class="selector-button selector-active">Day 1</button>
            <button id="day-2-button" onclick="changeDay('Day 2')" class="selector-button selector-inactive">Day 2</button>
        </div>

        <div class="flex justify-center space-x-4 mb-6">
            <button id="morning-shift-button" onclick="changeShift('Morning')" class="selector-button selector-active">Morning Shift</button>
            <button id="evening-shift-button" onclick="changeShift('Evening')" class="selector-button selector-inactive">Evening Shift</button>
        </div>


        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4 p-4 bg-white rounded-xl shadow-md">
            <button onclick="showResetConfirmation()"
                    class="flex items-center justify-center bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0114.958 7.502A1 1 0 0117.936 15h-1.845a7.001 7.001 0 00-12.729-3.411 1 1 0 01-.485-.718V3a1 1 0 011-1zm3 10a1 1 0 100 2h3a1 1 0 100-2H7z" clip-rule="evenodd" />
                </svg>
                Reset <span id="reset-day-label">Day 1</span>
            </button>
            
            <button onclick="exportDataToCsv()"
                    class="flex items-center justify-center bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200 text-sm shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Download Data (CSV)
            </button>

            <button id="admin-toggle-button" onclick="toggleAdminMode()"
                    class="flex items-center justify-center bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200 text-sm shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                </svg>
                Admin Mode (Off)
            </button>
        </div>

        <div id="admin-panel" class="admin-panel bg-white rounded-xl shadow-lg mb-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2 px-4">Add New Task to <span id="admin-context-label">Day 1 - Morning</span></h3>
            <div class="flex space-x-2 px-4">
                <input type="text" id="new-task-input" placeholder="Enter new task description" 
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="addTask()" 
                        class="bg-indigo-600 text-white p-2 px-4 rounded-lg hover:bg-indigo-700 font-semibold text-sm shadow-md">
                    Add
                </button>
            </div>
        </div>

        <div id="active-tasks-container" class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Active Tasks (<span id="active-task-count-label">0</span> To Do / In Progress)</h2>
            <div id="active-tasks-list" class="task-list space-y-3">
                <p class="text-center text-gray-400">Loading tasks...</p>
            </div>
        </div>

        <div id="completed-tasks-container" class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Completed Tasks (<span id="completed-task-count-label">0</span>)</h2>
            <div id="completed-tasks-list" class="task-list space-y-3 bg-gray-100 p-2 rounded-lg">
                <p class="text-center text-gray-400">No tasks completed yet.</p>
            </div>
        </div>

        <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div id="confirm-card" class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full text-center">
                
                <div id="reset-confirm-ui">
                    <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-3">Confirm Action</h3>
                    <p id="confirm-message" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
                    <div id="confirm-button-group" class="flex justify-between space-x-4">
                        <button id="confirm-cancel" class="flex-1 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 font-semibold">Cancel</button>
                        <button id="confirm-ok" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 font-semibold">OK</button>
                    </div>
                </div>

                <div id="reset-progress-ui" class="hidden">
                    <h3 id="progress-title" class="text-xl font-bold text-gray-800 mb-4">Processing Reset...</h3>
                    
                    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%"></div>
                    </div>

                    <div id="success-message" class="text-green-600 font-semibold flex items-center justify-center space-x-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span>Reset Successful!</span>
                    </div>
                    
                    <button id="progress-close-button" onclick="hideConfirmationModal()"
                            class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold mt-4 hidden">
                        Close
                    </button>
                </div>

            </div>
        </div>

    </div>

    <script>
        // Set the log level to 'debug' to see detailed logs in the console
        const LOG_PREFIX = '[KanbanApp]';
        
        const STORAGE_KEY_PREFIX = 'kanban_team_list_';
        const teamKeyInput = document.getElementById('team-key-input');
        const loadBoardButton = document.getElementById('load-board-button');
        const modal = document.getElementById('modal');
        const appContainer = document.getElementById('app-container');
        const activeTasksList = document.getElementById('active-tasks-list');
        const completedTasksList = document.getElementById('completed-tasks-list');
        const adminPanel = document.getElementById('admin-panel');
        const adminToggleButton = document.getElementById('admin-toggle-button');
        const newTaskInput = document.getElementById('new-task-input');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkButton = document.getElementById('confirm-ok');
        const confirmCancelButton = document.getElementById('confirm-cancel');
        const mainTitle = document.getElementById('main-title');
        const adminContextLabel = document.getElementById('admin-context-label');
        const resetDayLabel = document.getElementById('reset-day-label');
        const activeTaskCountLabel = document.getElementById('active-task-count-label');
        const completedTaskCountLabel = document.getElementById('completed-task-count-label');

        // New UI elements for the progress bar
        const resetConfirmUI = document.getElementById('reset-confirm-ui');
        const resetProgressUI = document.getElementById('reset-progress-ui');
        const progressBar = document.getElementById('progress-bar');
        const progressTitle = document.getElementById('progress-title');
        const successMessage = document.getElementById('success-message');
        const progressCloseButton = document.getElementById('progress-close-button');
        const confirmButtonGroup = document.getElementById('confirm-button-group');

        let currentTeamKey = '';
        let tasks = [];
        let isAdminMode = false;
        let currentDay = 'Day 1';
        let currentShift = 'Morning';

        // --- 50 Initial Tasks (Day 1) ---
        const initialTasks = [];
        const MORNING_SHIFT_TASKS = 25;
        const EVENING_SHIFT_TASKS = 25;
        
        const baseTasks = [
            'Clean all Toilets and Break Rooms',
            'QA Check: Inspect Area 1 floors and baseboards',
            'Break Room: Fully restock all coffee and tea supplies',
            'Wipe down all high-touch surfaces (door handles, switches)',
            'Polish all chrome and mirrors in bathrooms',
            'Restock all soap and paper products',
            'Final sweep and mop of all hard floor areas',
            'Check all trash receptacles for liners',
            'Sanitize all cleaning equipment and carts',
            'Check main entrance glass doors',
        ];

        // Generate Day 1 tasks (50 total)
        for (let i = 1; i <= MORNING_SHIFT_TASKS; i++) {
            const index = (i - 1) % baseTasks.length;
            initialTasks.push({ 
                id: `d1_m_${i}`, 
                text: `MORNING ${i}: ${baseTasks[index]}`, 
                day: 'Day 1',
                shift: 'Morning',
                status: 'todo', 
                startTime: null, endTime: null, duration: null
            });
        }
        for (let i = 1; i <= EVENING_SHIFT_TASKS; i++) {
            const index = (i - 1) % baseTasks.length;
            initialTasks.push({ 
                id: `d1_e_${i}`, 
                text: `EVENING ${i}: Deep clean and final closeout - ${baseTasks[index]}`, 
                day: 'Day 1',
                shift: 'Evening',
                status: 'todo', 
                startTime: null, endTime: null, duration: null
            });
        }
        
        // Add a few placeholder tasks for Day 2
        initialTasks.push({ id: 'd2_m_1', text: 'Day 2 Morning: Test system run', day: 'Day 2', shift: 'Morning', status: 'todo', startTime: null, endTime: null, duration: null });
        initialTasks.push({ id: 'd2_e_1', text: 'Day 2 Evening: Final inspection', day: 'Day 2', shift: 'Evening', status: 'todo', startTime: null, endTime: null, duration: null });


        // --- Core Functions ---

        /**
         * Generates a simple unique ID for new tasks using the current timestamp.
         */
        function generateUniqueId() {
            return 'custom_' + Date.now();
        }

        /**
         * Converts milliseconds to a human-readable duration string (e.g., "1h 35m").
         */
        function formatDuration(ms) {
            if (!ms || ms < 0) return 'N/A';
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0 && hours === 0 && minutes === 0) parts.push(`${seconds}s`);
            
            return parts.length > 0 ? parts.join(' ') : 'Less than 1s';
        }

        /**
         * Converts a JavaScript timestamp to a readable date/time string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString();
        }

        /**
         * Saves the current task state to Local Storage using the team key.
         */
        function saveTasks() {
            console.log(`${LOG_PREFIX} [SAVE] Key: ${currentTeamKey}. Saving ${tasks.length} tasks.`);
            try {
                localStorage.setItem(STORAGE_KEY_PREFIX + currentTeamKey, JSON.stringify(tasks));
            } catch (e) {
                console.error(`${LOG_PREFIX} Error saving to Local Storage:`, e);
            }
        }

        /**
         * Loads tasks from Local Storage, merging with initial tasks to ensure defaults exist.
         */
        function loadTasks() {
            console.log(`${LOG_PREFIX} [LOAD] Attempting to load tasks for key: ${currentTeamKey}`);
            const storedData = localStorage.getItem(STORAGE_KEY_PREFIX + currentTeamKey);
            let loadedTasks = [];

            if (storedData) {
                try {
                    loadedTasks = JSON.parse(storedData);
                    loadedTasks = loadedTasks.map(t => ({
                        ...t,
                        startTime: t.startTime || null,
                        endTime: t.endTime || null,
                        duration: t.duration || null,
                        day: t.day || 'Day 1', 
                        shift: t.shift || 'Morning',
                        status: t.status || 'todo'
                    }));
                    console.log(`${LOG_PREFIX} [LOAD] Successfully loaded ${loadedTasks.length} tasks from storage.`);

                } catch (e) {
                    console.error(`${LOG_PREFIX} Error parsing stored data:`, e);
                }
            } else {
                 console.log(`${LOG_PREFIX} [LOAD] No data found in storage. Using initial task set.`);
            }
            
            // Merge initial tasks and stored tasks, prioritizing stored state
            const taskMap = new Map();
            
            // Add initial tasks first
            initialTasks.forEach(t => taskMap.set(t.id, t));
            
            // Overwrite with stored state
            loadedTasks.forEach(t => taskMap.set(t.id, t));

            tasks = Array.from(taskMap.values());
            
            // If the local storage was empty or failed, save the initial set
            if (!storedData) {
                saveTasks();
            }

            renderTasks();
        }
        
        /**
         * Updates the UI based on the current day and shift selected.
         */
        function updateUIContext() {
            mainTitle.textContent = `${currentDay} - ${currentShift} Shift`;
            adminContextLabel.textContent = `${currentDay} - ${currentShift}`;
            resetDayLabel.textContent = currentDay;
            
            // Update Day Selector buttons
            document.querySelectorAll('[id^="day-"]').forEach(btn => {
                const day = btn.getAttribute('onclick').match(/changeDay\('(.*)'\)/)[1];
                btn.className = 'selector-button';
                btn.classList.add(day === currentDay ? 'selector-active' : 'selector-inactive');
            });
            
            // Update Shift Selector buttons
            document.querySelectorAll('[id$="-shift-button"]').forEach(btn => {
                const shift = btn.getAttribute('onclick').match(/changeShift\('(.*)'\)/)[1];
                btn.className = 'selector-button';
                btn.classList.add(shift === currentShift ? 'selector-active' : 'selector-inactive');
            });
        }

        /**
         * Renders all tasks into two separate lists: Active and Completed.
         */
        function renderTasks() {
            console.log(`${LOG_PREFIX} [RENDER] Rendering tasks for ${currentDay} - ${currentShift}. Total tasks in list: ${tasks.length}`);

            updateUIContext();
            activeTasksList.innerHTML = '';
            completedTasksList.innerHTML = '';

            const relevantTasks = tasks.filter(t => t.day === currentDay && t.shift === currentShift);

            const activeTasks = relevantTasks
                .filter(t => t.status === 'todo' || t.status === 'inprogress')
                .sort((a, b) => {
                    // Sort order: In Progress (0) -> To Do (1)
                    const statusOrder = { 'inprogress': 0, 'todo': 1 };
                    return statusOrder[a.status] - statusOrder[b.status];
                });
                
            const completedTasks = relevantTasks
                .filter(t => t.status === 'completed')
                // Sort completed tasks by most recently finished (endTime descending)
                .sort((a, b) => b.endTime - a.endTime);
                
            activeTaskCountLabel.textContent = activeTasks.length;
            completedTaskCountLabel.textContent = completedTasks.length;

            // Render Active Tasks
            activeTasks.forEach(task => {
                const card = createTaskCard(task);
                activeTasksList.appendChild(card);
            });
            
            if (activeTasks.length === 0) {
                activeTasksList.innerHTML = `<p class="text-center text-gray-500 p-4 bg-indigo-50 rounded-lg">All tasks completed for this shift! Ready for the next one.</p>`;
            }
            
            // Render Completed Tasks
            completedTasks.forEach(task => {
                const card = createTaskCard(task);
                completedTasksList.appendChild(card);
            });

            if (completedTasks.length === 0) {
                completedTasksList.innerHTML = `<p class="text-center text-gray-400 p-4">No tasks completed yet.</p>`;
            }
        }

        /**
         * Creates the HTML element for a single time-tracked task.
         */
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.id = task.id;
            card.classList.add('p-4', 'rounded-lg', 'shadow-sm', 'flex', 'justify-between', 'items-center', 'transition-colors', 'duration-200');
            
            let actionButtonHTML = '';
            let durationDisplay = '';
            let textColor = 'text-gray-800';
            
            // Determine card appearance and button state based on status
            if (task.status === 'completed') {
                card.classList.add('bg-green-100', 'border-l-4', 'border-green-500');
                textColor = 'text-green-700';
                const duration = formatDuration(task.duration);
                durationDisplay = `<span class="text-xs font-semibold text-gray-500">Time Taken: ${duration}</span>`;
                actionButtonHTML = `<span class="text-sm font-bold text-green-600">DONE</span>`;
            } else if (task.status === 'inprogress') {
                card.classList.add('bg-yellow-100', 'border-l-4', 'border-yellow-500');
                textColor = 'text-yellow-800';
                actionButtonHTML = `<button onclick="completeTask('${task.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-white p-2 px-3 rounded-lg text-sm font-semibold shadow-md">Mark Complete</button>`;
                durationDisplay = `<span class="text-sm text-yellow-700 font-medium">In Progress...</span>`;
            } else { // todo
                card.classList.add('bg-indigo-50', 'border-l-4', 'border-indigo-300');
                textColor = 'text-gray-800';
                actionButtonHTML = `<button onclick="startTask('${task.id}')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 px-3 rounded-lg text-sm font-semibold shadow-md">Start Task</button>`;
            }
            
            // Admin Delete Button (visible only in Admin Mode)
            let deleteButtonHTML = '';
            // Only allow deletion of tasks that are NOT part of the initial set
            const isCustomTask = !task.id.startsWith('d1_') && !task.id.startsWith('d2_');

            if (isAdminMode && isCustomTask) {
                deleteButtonHTML = `
                    <button onclick="deleteTaskConfirmation('${task.id}')" class="text-red-500 hover:text-red-700 ml-3 transition-colors flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
            }

            // Task content area
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('flex-grow', 'flex', 'flex-col');
            contentDiv.innerHTML = `
                <p class="font-medium ${textColor} mb-1">${task.text}</p>
                ${task.status === 'completed' ? durationDisplay : ''}
            `;

            // Controls/Info area
            const controlDiv = document.createElement('div');
            controlDiv.classList.add('flex', 'items-center', 'space-x-4', 'ml-4', 'flex-shrink-0');
            controlDiv.innerHTML = `${task.status !== 'completed' ? durationDisplay : ''} ${actionButtonHTML} ${deleteButtonHTML}`;

            card.appendChild(contentDiv);
            card.appendChild(controlDiv);
            
            return card;
        }
        
        // --- Day/Shift Selector Handlers ---
        
        window.changeDay = function(day) {
            currentDay = day;
            renderTasks();
            saveTasks();
        }

        window.changeShift = function(shift) {
            currentShift = shift;
            renderTasks();
            saveTasks();
        }

        // --- Task State Handlers ---
        
        window.startTask = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.status === 'todo') {
                task.status = 'inprogress';
                task.startTime = Date.now();
                saveTasks();
                renderTasks();
            }
        }

        window.completeTask = function(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.status === 'inprogress') {
                task.status = 'completed';
                task.endTime = Date.now();
                task.duration = task.endTime - task.startTime; 
                saveTasks();
                renderTasks();
            }
        }
        
        /**
         * Executes the core logic to reset ALL tasks for the currentDay.
         */
        window.resetTasksLogic = function() { // Renamed from resetTasks to prevent confusion with the UI flow
            const tasksBefore = tasks.filter(t => t.day === currentDay).length;
            let resetCount = 0;

            tasks = tasks.map(task => {
                // Only reset tasks belonging to the current day
                if (task.day === currentDay) { 
                    resetCount++;
                    return {
                        ...task,
                        status: 'todo',
                        startTime: null,
                        endTime: null,
                        duration: null
                    };
                }
                return task;
            });
            console.log(`${LOG_PREFIX} [RESET SUCCESS] Resetting for ${currentDay}. Tasks to reset: ${tasksBefore}. Actually reset: ${resetCount}. Calling save/render.`);
            
            // IMPORTANT: Save and Render after the logic is complete
            saveTasks();
            renderTasks();
        }
        
        /**
         * Adds a new custom task to the list, assigned to the current Day/Shift.
         */
        window.addTask = function() {
            const text = newTaskInput.value.trim();
            if (text) {
                const newTask = {
                    id: generateUniqueId(),
                    text: text,
                    day: currentDay,
                    shift: currentShift,
                    status: 'todo',
                    startTime: null,
                    endTime: null,
                    duration: null
                };
                tasks.push(newTask);
                newTaskInput.value = ''; // Clear input
                saveTasks();
                renderTasks();
            }
        }

        /**
         * **FIXED** Handles the confirmation and execution of deleting a custom task by ID.
         */
        window.deleteTaskConfirmation = function(taskId) {
            const taskToDelete = tasks.find(t => t.id === taskId);
            
            if (!taskToDelete) {
                console.error(`${LOG_PREFIX} Task not found for deletion:`, taskId);
                return;
            }
            
            // Check if it's a template task (d1_ or d2_)
            const isCustomTask = !taskId.startsWith('d1_') && !taskId.startsWith('d2_');
            if (!isCustomTask) {
                console.warn(`${LOG_PREFIX} Attempted to delete template task ID: ${taskId}. Deletion restricted.`);
                return; 
            }

            // Ensure confirmation UI is shown for delete operations
            resetConfirmUI.classList.remove('hidden');
            resetProgressUI.classList.add('hidden');

            showConfirmationModal({
                title: 'Confirm Deletion',
                message: `Are you sure you want to permanently delete the custom task: "${taskToDelete.text}"? This action cannot be undone.`,
                onConfirm: () => {
                    const tasksBefore = tasks.length;
                    console.log(`${LOG_PREFIX} [DELETE START] Task ID: ${taskId}. Tasks before: ${tasksBefore}`);
                    
                    // --- CRITICAL FIX: The deletion logic must be run here ---
                    tasks = tasks.filter(t => t.id !== taskId);
                    
                    const tasksAfter = tasks.length;
                    console.log(`${LOG_PREFIX} [DELETE SUCCESS] Task ID: ${taskId} removed. Tasks after: ${tasksAfter}. Change: ${tasksBefore - tasksAfter}. Calling save/render.`);

                    // 1. Persist the change
                    saveTasks();
                    // 2. Update the screen
                    renderTasks();
                    // 3. Close the modal
                    hideConfirmationModal();
                },
                confirmText: 'Delete Permanently',
                confirmClass: 'bg-red-600 hover:bg-red-700'
            });
        }
        
        // --- Data Export Function ---

        /**
         * Exports all task data across all days and shifts to a CSV file.
         */
        window.exportDataToCsv = function() {
            console.log(`${LOG_PREFIX} [EXPORT] Starting CSV data export...`);

            const headers = [
                "Task ID", "Day", "Shift", "Task Description", "Status", 
                "Start Time (UTC)", "End Time (UTC)", "Duration (ms)", 
                "Duration (Human Readable)"
            ];
            
            // Format task data into CSV rows
            const csvRows = tasks.map(task => {
                // Sanitize text for CSV: remove quotes and wrap in new quotes
                const text = `"${task.text.replace(/"/g, '""')}"`; 
                
                return [
                    task.id,
                    task.day,
                    task.shift,
                    text,
                    task.status,
                    formatTimestamp(task.startTime),
                    formatTimestamp(task.endTime),
                    task.duration || 0,
                    formatDuration(task.duration)
                ].join(',');
            });
            
            // Combine headers and rows
            const csvContent = [
                headers.join(','),
                ...csvRows
            ].join('\n');
            
            // Create a blob and link to download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `Task_Completion_Data_${currentTeamKey}_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`${LOG_PREFIX} [EXPORT] CSV file download initiated.`);
        }

        
        // --- Admin Mode Toggling ---

        window.toggleAdminMode = function() {
            isAdminMode = !isAdminMode;
            
            adminPanel.classList.toggle('open');
            
            if (isAdminMode) {
                adminToggleButton.textContent = 'Admin Mode (On)';
                adminToggleButton.classList.remove('bg-gray-200', 'text-gray-700');
                adminToggleButton.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
            } else {
                adminToggleButton.textContent = 'Admin Mode (Off)';
                adminToggleButton.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                adminToggleButton.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            renderTasks();
        }
        
        // --- Custom Confirmation Modal Logic (for both reset and delete) ---

        /**
         * Sets up the modal for a confirmation or deletion prompt.
         */
        function showConfirmationModal(options) {
            // Use the standard confirmation UI fields
            document.getElementById('confirm-title').textContent = options.title || 'Confirmation';
            document.getElementById('confirm-message').textContent = options.message || 'Are you sure?';
            confirmOkButton.textContent = options.confirmText || 'OK';

            // Reset classes and apply custom class
            confirmOkButton.className = 'flex-1 text-white py-2 rounded-lg font-semibold';
            confirmOkButton.classList.add(options.confirmClass || 'bg-indigo-600', options.confirmClass.replace('bg-', 'hover:bg-') || 'hover:bg-indigo-700');

            // Clear previous listeners and add new ones
            confirmOkButton.onclick = options.onConfirm;
            confirmCancelButton.onclick = hideConfirmationModal;

            confirmModal.classList.remove('hidden');
        }

        /**
         * Hides the confirmation modal and resets its state for the next call.
         */
        function hideConfirmationModal() {
            confirmModal.classList.add('hidden');
            
            // Ensure the default confirmation UI is visible next time
            resetConfirmUI.classList.remove('hidden');
            resetProgressUI.classList.add('hidden');
            
            // Reset progress elements (important for reset logic)
            progressBar.style.width = '0%';
            progressTitle.textContent = "Processing Reset...";
            successMessage.classList.add('hidden');
            progressCloseButton.classList.add('hidden');
            document.getElementById('progress-bar-container').classList.remove('hidden');

            // Restore elements in the confirm UI
            document.getElementById('confirm-title').classList.remove('hidden');
            document.getElementById('confirm-message').classList.remove('hidden');
            confirmButtonGroup.classList.remove('hidden');
        }

        /**
         * 1. Shows the initial reset confirmation modal.
         */
        window.showResetConfirmation = function() {
            // Set up the modal to show the standard confirmation UI first
            resetConfirmUI.classList.remove('hidden');
            resetProgressUI.classList.add('hidden');
            
            showConfirmationModal({
                title: `Confirm Reset for ${currentDay}`,
                message: `Are you sure you want to reset ALL tasks for ${currentDay} (Morning and Evening shifts)? This action cannot be undone.`,
                onConfirm: window.triggerResetFlow,
                confirmText: `Reset ${currentDay}`,
                confirmClass: 'bg-red-600 hover:bg-red-700'
            });
        }
        
        /**
         * Simulates a progress bar filling up over time.
         */
        window.simulateProgress = function() {
            
            resetConfirmUI.classList.add('hidden');
            resetProgressUI.classList.remove('hidden');

            let currentProgress = 0;
            const intervalTime = 50; // ms
            const duration = 1500; // Total duration in ms for animation
            const steps = duration / intervalTime;
            const increment = 100 / steps;

            const interval = setInterval(() => {
                currentProgress += increment;
                
                if (currentProgress >= 95) {
                    // Stop just before 100% to simulate processing time
                    currentProgress = 95;
                    clearInterval(interval);
                }
                progressBar.style.width = `${Math.floor(currentProgress)}%`;
            }, intervalTime);
            
            return interval;
        }

        /**
         * 2. Triggers the animation, executes the logic, and shows success.
         */
        window.triggerResetFlow = function() {
            // 1. Start the visual progress bar animation
            const interval = simulateProgress();
            
            // 2. Execute the reset logic after a small delay (to allow the bar to reach ~95%)
            setTimeout(() => {
                // Stop the visual interval
                clearInterval(interval); 
                
                // Ensure the bar is at 100%
                progressBar.style.width = '100%'; 

                // 3. Execute the actual reset logic
                window.resetTasksLogic(); 
                
                // 4. Show success confirmation
                progressTitle.textContent = "Complete!";
                document.getElementById('progress-bar-container').classList.add('hidden');
                successMessage.classList.remove('hidden');
                progressCloseButton.classList.remove('hidden');
                
            }, 1500); // 1.5 seconds simulation time
        }
        
        // --- Initialization and UI Logic ---
        
        /**
         * Initializes the board UI and loads/saves tasks based on the given key.
         */
        function initializeBoard(key) {
            currentTeamKey = key;
            
            if (window.location.hash.substring(1) !== key) {
                window.location.hash = key;
            }
            
            document.getElementById('current-key-display').textContent = currentTeamKey;
            
            modal.style.setProperty('display', 'none', 'important'); 
            appContainer.style.setProperty('display', 'block', 'important'); 

            loadTasks();
        }

        function initApp() {
            const hashKey = window.location.hash.substring(1); 
            if (hashKey) {
                initializeBoard(hashKey);
            } else {
                modal.style.display = 'flex';
            }
        }
        
        loadBoardButton.addEventListener('click', () => {
            const key = teamKeyInput.value.trim();
            if (key) {
                initializeBoard(key);
            } else {
                const error = document.getElementById('key-error');
                error.style.display = 'block';
                setTimeout(() => error.style.display = 'none', 3000);
            }
        });
        
        window.addEventListener('load', initApp);
        console.log(`${LOG_PREFIX} Application loaded. Please test Admin Delete and Reset features.`);

    </script>
</body>
</html>


